import os
import json
from datetime import datetime
import config.settings as settings

TIMELINE_DIR = None
TIMELINE_JSON = None
TIMELINE_HTML_MATRIX_CLEAN = None

def _init_paths():
    global TIMELINE_DIR, TIMELINE_JSON, TIMELINE_HTML_MATRIX_CLEAN
    if TIMELINE_DIR is None:
        TIMELINE_DIR = os.path.join(getattr(settings, 'LOG_FOLDER', '.'), 'timeline')
    if TIMELINE_JSON is None:
        TIMELINE_JSON = os.path.join(TIMELINE_DIR, 'events_matrix.json')
    if TIMELINE_HTML_MATRIX_CLEAN is None:
        TIMELINE_HTML_MATRIX_CLEAN = os.path.join(TIMELINE_DIR, 'index2.html')
    os.makedirs(TIMELINE_DIR, exist_ok=True)


def _load_events():
    _init_paths()
    if not os.path.exists(TIMELINE_JSON):
        return []
    try:
        with open(TIMELINE_JSON, 'r', encoding='utf-8') as f:
            data = json.load(f)
            if isinstance(data, list):
                return data
            return []
    except Exception:
        return []


def _save_events(events):
    _init_paths()
    try:
        with open(TIMELINE_JSON, 'w', encoding='utf-8') as f:
            json.dump(events, f, ensure_ascii=False, indent=2)
    except Exception:
        pass


def _group_diffs_by_address(diffs: list):
    out = {}
    for d in (diffs or []):
        addr = d.get('address') or ''
        out.setdefault(addr, []).append(d)
    return out

def export_event(event: dict):
    """
    Append a timeline event to events.json and regenerate index.html.
    Expected keys: timestamp(str), file(str), filename(str), worksheet(str or 'all'),
                   changes(int), author(str), event_number(int or None),
                   snapshot_path(str or None), per_event_path(str or None)
    """
    try:
        events = _load_events()
        # Normalize and enrich
        evt = dict(event or {})
        if not evt.get('timestamp'):
            evt['timestamp'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        evt['file'] = os.path.abspath(evt.get('file') or evt.get('file_path') or evt.get('filename') or '')
        evt['filename'] = os.path.basename(evt.get('file') or '')
        # Optional: attach limited diffs for file-centric view
        if evt.get('diffs') is not None:
            try:
                # ä¹Ÿé å…ˆé™„ä¸ŠæŒ‰ Address èšåˆçš„è¦–åœ–è³‡æ–™ï¼ˆä¾›å‰ç«¯åˆ‡æ›ï¼‰
                evt['diffs_by_address'] = _group_diffs_by_address(evt.get('diffs') or [])
            except Exception:
                pass
        # è¼•é‡å»é‡ï¼šä»¥ (file, event_number, timestamp) ç‚ºç°½å
        sig = (evt.get('file',''), evt.get('event_number',''), evt.get('timestamp',''))
        exists = any((e.get('file',''), e.get('event_number',''), e.get('timestamp','')) == sig for e in events)
        if not exists:
            events.append(evt)
        # Keep a reasonable size (e.g., last 20000)
        if len(events) > 20000:
            events = events[-20000:]
        _save_events(events)
        generate_html(events)
        # Debug paths
        try:
            # ç¸½æ˜¯é¡¯ç¤º HTML è·¯å¾‘è¨Šæ¯ï¼Œæ–¹ä¾¿ç”¨æˆ¶æ‰¾åˆ°æ–‡ä»¶
            print(f"[timeline-html] HTML å·²ç”Ÿæˆ: {TIMELINE_HTML}")
            if getattr(settings, 'SHOW_DEBUG_MESSAGES', False):
                try:
                    from utils.debug import debug_print
                    debug_print('timeline-html', {
                        'dir': TIMELINE_DIR,
                        'json': TIMELINE_JSON,
                        'html': TIMELINE_HTML,
                        'events': len(events),
                        'last_file': evt.get('file','')
                    })
                except Exception:
                    print(f"[timeline-html] dir={TIMELINE_DIR} json={TIMELINE_JSON} html={TIMELINE_HTML} events={len(events)} last_file={evt.get('file','')}")
        except Exception:
            pass
    except Exception:
        # timeline failure should not affect main flow
        pass


def generate_html(events=None, output_path=None, title_suffix=""):
    """Write a static HTML (self-contained) that lists events with simple filtering."""
    try:
        _init_paths()
        if events is None:
            events = _load_events()
        # Filter display: drop no-change events when TIMELINE_RECORD_NO_CHANGE is False
        try:
            if not getattr(settings, 'TIMELINE_RECORD_NO_CHANGE', False):
                before = len(events)
                events = [e for e in (events or []) if int(e.get('changes', 0) or 0) != 0]
                removed = before - len(events)
                if removed and getattr(settings, 'SHOW_DEBUG_MESSAGES', False):
                    print(f"[timeline] filtered no-change events (display only): removed={removed} total_now={len(events)}")
        except Exception:
            pass
        # Latest first
        try:
            events = sorted(events, key=lambda e: e.get('timestamp', ''), reverse=True)
        except Exception:
            pass
        # Minimal self-contained HTML + vanilla JS (no CDN)
        html = []
        html.append('<!DOCTYPE html>')
        html.append('<html lang="zh-Hant">')
        html.append('<head><meta charset="utf-8"/>')
        html.append('<title>Excel Timeline - Matrixé¢¨æ ¼</title>')
        html.append('<style>')
        html.append('  body{font-family:Consolas,Monaco,Courier New,monospace;margin:16px;background:#000;color:#00ff41;text-shadow:0 0 3px #00ff41;}')
        html.append('  table{border-collapse:collapse;width:100%;border:1px solid #00ff41;background:#000;}')
        html.append('  th,td{border:1px solid #00ff41;padding:6px;word-break:break-all;overflow:hidden;min-width:60px;color:#00ff41;text-shadow:0 0 2px #00ff41;}')
        html.append('  th{background:#001100;position:sticky;top:0;cursor:default;}')
        html.append('  th:hover{background:#002200;}')
        html.append('  .muted{color:#006600;font-size:12px}')
        html.append('  input{padding:6px;margin:4px 8px 12px 0;background:#000;color:#00ff41;border:1px solid #00ff41;text-shadow:0 0 3px #00ff41;}')
        html.append('  .formula-cell{color:#00ddaa;}')
        html.append('  .formula-diff-deleted{background-color:rgba(255,68,68,0.2);text-decoration:line-through;color:#ff4444;}')
        html.append('  .formula-diff-added{background-color:rgba(0,255,65,0.2);color:#00ff88;}')
        html.append('  .formula-diff-unchanged{color:#888888;}')
        html.append('  button{padding:5px 10px;margin-right:5px;cursor:pointer;background:#000;color:#00ff41;border:1px solid #00ff41;text-shadow:0 0 3px #00ff41;}')
        html.append('  .author-filter, .worksheet-filter{margin:5px 0;}')
        html.append('  .author-tag, .worksheet-tag{display:inline-block;padding:3px 6px;margin:2px;background:rgba(0,255,65,0.1);border:1px solid #00ff41;border-radius:3px;cursor:pointer;color:#00ff41;}')
        html.append('  .author-highlight{background-color:rgba(255,255,0,0.2);}')
        html.append('  .controls{margin:10px 0;padding:10px;background:#000;border:1px solid #00ff41;border-radius:4px;}')
        html.append('  .column-toggle{margin-right:10px;white-space:nowrap;color:#00ff41;}')
        html.append('  .summary-box{margin:10px 0;padding:10px;background:#000;border:1px solid #00ff41;border-radius:4px;color:#00ff41;}')
        html.append('  .export-btn{background:#000;color:#00ff41;border:1px solid #00ff41;padding:6px 12px;border-radius:4px;}')
        html.append('  .filters-container{display:flex;flex-direction:column;gap:5px;}')
        html.append('  /* å‹•æ…‹å¯¬åº¦å°‡ç”± JavaScript è¨ˆç®— */')
        html.append('  .col-time {min-width:120px; max-width:150px;}')
        html.append('  .col-author {min-width:60px; max-width:120px;}')
        html.append('  .col-worksheet {min-width:60px; max-width:100px;}')
        html.append('  .col-address {min-width:50px; max-width:80px;}')
        html.append('  .col-oldvalue, .col-newvalue, .col-valuediff {min-width:80px; max-width:200px; white-space: normal; overflow-wrap: anywhere; word-break: break-word;}')
        html.append('  .col-oldformula, .col-newformula, .col-formuladiff {min-width:250px; width:250px; max-width:250px;}')
        html.append('  .diff-table{table-layout:fixed;}')
        html.append('  .diff-table td{overflow:hidden;text-overflow:ellipsis;}')
        html.append('  .col-oldformula, .col-newformula, .col-formuladiff {white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-word; overflow: visible; text-overflow: initial;}')
        html.append('  /* è‡ªé©æ‡‰åˆ—å¯¬åº¦æ¨£å¼ */')
        html.append('  table.auto-size-columns .col-worksheet,')
        html.append('  table.auto-size-columns .col-address,')
        html.append('  table.auto-size-columns .col-event,')
        html.append('  table.auto-size-columns .col-time,')
        html.append('  table.auto-size-columns .col-author {')
        html.append('    white-space: nowrap;')
        html.append('    max-width: none;')
        html.append('  }')
        html.append('  /* å…¬å¼åˆ—ç¸½æ˜¯æ›è¡Œï¼Œé¿å…è¡¨æ ¼éå¯¬ */')
        html.append('  .col-oldformula, .col-newformula, .col-formuladiff {')
        html.append('    word-break: break-word;')
        html.append('    min-width: 150px;')
        html.append('    max-width: 350px;')
        html.append('  }')
        html.append('  /* å€¼åˆ—ç¸½æ˜¯æ›è¡Œï¼Œä½†çµ¦äºˆé©ç•¶ç©ºé–“ */')
        html.append('  .col-oldvalue, .col-newvalue {')
        html.append('    word-break: break-word;')
        html.append('    min-width: 120px;')
        html.append('    max-width: 300px;')
        html.append('  }')
        html.append('  ')
        html.append('  /* æ˜äº®ä¸»é¡Œæ¨£å¼ */')
        html.append('  body.light-theme {')
        html.append('    background: #ffffff !important;')
        html.append('    color: #333333 !important;')
        html.append('    text-shadow: none !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme h2 {')
        html.append('    color: #2c3e50 !important;')
        html.append('    text-shadow: none !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme table {')
        html.append('    border: 1px solid #ddd;')
        html.append('    background: #ffffff;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme th,')
        html.append('  body.light-theme td {')
        html.append('    border: 1px solid #ddd;')
        html.append('    color: #333333;')
        html.append('    text-shadow: none;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme th {')
        html.append('    background: #f8f9fa;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme th:hover {')
        html.append('    background: #e9ecef;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .muted {')
        html.append('    color: #6c757d;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme input {')
        html.append('    background: #ffffff !important;')
        html.append('    color: #333333 !important;')
        html.append('    border: 1px solid #ced4da !important;')
        html.append('    text-shadow: none !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme button {')
        html.append('    background: #ffffff !important;')
        html.append('    color: #333333 !important;')
        html.append('    border: 1px solid #ced4da !important;')
        html.append('    text-shadow: none !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme button:hover {')
        html.append('    background: #f8f9fa;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .author-tag,')
        html.append('  body.light-theme .worksheet-tag {')
        html.append('    background: #e9ecef;')
        html.append('    border: 1px solid #ced4da;')
        html.append('    color: #333333;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .controls,')
        html.append('  body.light-theme .summary-box {')
        html.append('    background: #ffffff !important;')
        html.append('    border: 1px solid #dee2e6 !important;')
        html.append('    color: #333333 !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .column-toggle {')
        html.append('    color: #333333;')
        html.append('  }')
        html.append('  ')
        html.append('  /* å…¬å¼å·®ç•°åœ¨ç™½è‰²ä¸»é¡Œä¸‹ä¿æŒåŸæœ‰é¡è‰² */')
        html.append('  body.light-theme .formula-diff-deleted {')
        html.append('    background-color: rgba(255,68,68,0.2);')
        html.append('    color: #dc3545;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .formula-diff-added {')
        html.append('    background-color: rgba(40,167,69,0.2);')
        html.append('    color: #28a745;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .formula-diff-unchanged {')
        html.append('    color: #6c757d;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .author-highlight {')
        html.append('    background-color: rgba(255,193,7,0.3);')
        html.append('  }')
        html.append('  ')
        html.append('  /* ç¢ºä¿æ‰€æœ‰å…§è¯æ¨£å¼éƒ½è¢«è¦†è“‹ */')
        html.append('  body.light-theme * {')
        html.append('    border-color: #dee2e6 !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme table,')
        html.append('  body.light-theme th,')
        html.append('  body.light-theme td {')
        html.append('    background: #ffffff !important;')
        html.append('    color: #333333 !important;')
        html.append('  }')
        html.append('  ')
        html.append('  body.light-theme .muted {')
        html.append('    color: #6c757d !important;')
        html.append('  }')
        html.append('  ')
        html.append('  /* ç‰¹åˆ¥è™•ç†å…§è¯æ¨£å¼çš„è¼¸å…¥æ¡† */')
        html.append('  body.light-theme input[style*="background"] {')
        html.append('    background: #ffffff !important;')
        html.append('    color: #333333 !important;')
        html.append('    border: 1px solid #ced4da !important;')
        html.append('  }')
        html.append('</style>')
        html.append('</head><body>')
        main_title = "Excel Timeline" + title_suffix
        html.append(f'<h2 style="color:#00ff41;text-shadow:0 0 10px #00ff41;">{main_title}</h2>')
        html.append('<div class="muted">æç¤ºï¼šé»æª”åå¯å±•é–‹ã€Œæª”æ¡ˆè©³æƒ…è¦–åœ–ã€ï¼ˆæä¾›ã€Œä¾äº‹ä»¶æ™‚é–“ / ä¾ Address / ä¾ä½œè€…ã€ä¸‰ç¨®æª¢è¦–ï¼‰ã€‚</div>')
        html.append('<div style="display:flex;gap:15px;align-items:center;margin-bottom:10px;">')
        html.append('  <div>å¿«é€Ÿç¯©é¸ï¼š<input id="q" placeholder="é—œéµå­—ï¼ˆæª”å/è·¯å¾‘/ä½œè€…/å·¥ä½œè¡¨ï¼‰" style="width:360px"/></div>')
        html.append('  <button id="themeToggle" onclick="toggleTheme()" style="padding:8px 16px;background:#000;color:#00ff41;border:1px solid #00ff41;border-radius:4px;cursor:pointer;">ğŸŒ æ˜äº®æ¨¡å¼</button>')
        html.append('</div>')
        html.append('<div class="controls" style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>é¡¯ç¤ºå°æ•¸ä½æ•¸ï¼š</label>')
        html.append('    <input id="decimals" type="number" min="0" max="10" step="1" placeholder="auto" style="width:90px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('    <small class="muted">é è¨­ autoï¼ˆä¸å››æ¨äº”å…¥ï¼‰</small>')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>å€¼æ¬„å¯¬(px)ï¼š</label>')
        html.append('    <input id="valWidth" type="number" min="60" max="600" step="10" placeholder="ä¾‹å¦‚ 220" style="width:100px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>å…¬å¼æ¬„å¯¬(px)ï¼š</label>')
        html.append('    <input id="formWidth" type="number" min="120" max="800" step="10" placeholder="ä¾‹å¦‚ 280" style="width:100px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>æ™‚é–“(px)ï¼š</label>')
        html.append('    <input id="timeWidth" type="number" min="60" max="600" step="10" placeholder="auto" style="width:90px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('    <small class="muted">é è¨­ <span id="defTime">auto</span> px</small>')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>ä½œè€…(px)ï¼š</label>')
        html.append('    <input id="authorWidth" type="number" min="40" max="400" step="10" placeholder="auto" style="width:90px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('    <small class="muted">é è¨­ <span id="defAuthor">auto</span> px</small>')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>å·¥ä½œè¡¨(px)ï¼š</label>')
        html.append('    <input id="wsWidth" type="number" min="40" max="400" step="10" placeholder="auto" style="width:90px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('    <small class="muted">é è¨­ <span id="defWS">auto</span> px</small>')
        html.append('  </div>')
        html.append('  <div style="display:flex;gap:6px;align-items:center">')
        html.append('    <label>ä½ç½®(px)ï¼š</label>')
        html.append('    <input id="addrWidth" type="number" min="40" max="400" step="10" placeholder="auto" style="width:90px;background:#000;color:#00ff41;border:1px solid #00ff41;">')
        html.append('    <small class="muted">é è¨­ <span id="defAddr">auto</span> px</small>')
        html.append('  </div>')
        html.append('  <button id="applyWidths" class="view-btn">å¥—ç”¨</button>')
        html.append('  <button id="resetWidths" class="view-btn">é‡è¨­</button>')
        html.append('</div>')
        html.append('<div id="file-view" style="display:none;margin:12px 0;padding:8px;border:1px solid #00ff41;background:#000;color:#00ff41"></div>')
        html.append('<table id="tbl">')
        html.append('<thead><tr><th>æ™‚é–“</th><th>æª”å</th><th>å·¥ä½œè¡¨</th><th>è®Šæ›´æ•¸</th><th>ä½œè€…</th><th>äº‹ä»¶#</th><th>Baseline</th><th>Current</th><th>å¿«ç…§</th><th>è©³è¡¨</th><th class="muted">è·¯å¾‘</th></tr></thead>')
        html.append('<tbody>')
        for e in (events or []):
            ts = e.get('timestamp','')
            fn = e.get('filename','')
            ws = e.get('worksheet','') or ''
            ch = e.get('changes','')
            au = e.get('author','') or ''
            ev = e.get('event_number','') or ''
            fp = e.get('file','')
            sp = e.get('snapshot_path') or ''
            pp = e.get('per_event_path') or ''
            sp_link = f'<a href="{sp}" target="_blank">snapshot</a>' if sp else ''
            pp_link = f'<a href="{pp}" target="_blank">per-event</a>' if pp else ''
            bt = e.get('baseline_time','')
            ct = e.get('current_time','')
            html.append(f'<tr data-file="{fp}"><td>{ts}</td><td><a href="#" class="file-link" data-file="{fp}">{fn}</a></td><td>{ws}</td><td>{ch}</td><td>{au}</td><td>{ev}</td><td>{bt}</td><td>{ct}</td><td>{sp_link}</td><td>{pp_link}</td><td class="muted">{fp}</td></tr>')
        html.append('</tbody></table>')
        # å…§åµŒ events JSONï¼Œé¿å…åœ¨ JS å­—ä¸²ä¸­è™•ç†è·³è„«/é—œé–‰æ¨™ç±¤
        try:
            safe_json_tag = json.dumps(events, ensure_ascii=False).replace('</', '<\/')
        except Exception:
            safe_json_tag = '[]'
        html.append('<script id="events-data" type="application/json">'+ safe_json_tag +'</script>')
        html.append('<script>')
        html.append('// ä¸»é¡Œåˆ‡æ›åŠŸèƒ½')
        html.append('function toggleTheme() {')
        html.append('  const body = document.body;')
        html.append('  const isLight = body.classList.contains("light-theme");')
        html.append('  ')
        html.append('  if (isLight) {')
        html.append('    body.classList.remove("light-theme");')
        html.append('    localStorage.setItem("timeline_theme", "dark");')
        html.append('    document.getElementById("themeToggle").textContent = "ğŸŒ æ˜äº®æ¨¡å¼";')
        html.append('  } else {')
        html.append('    body.classList.add("light-theme");')
        html.append('    localStorage.setItem("timeline_theme", "light");')
        html.append('    document.getElementById("themeToggle").textContent = "ğŸŒ™ æ·±è‰²æ¨¡å¼";')
        html.append('  }')
        html.append('}')
        html.append('')
        html.append('// é é¢è¼‰å…¥æ™‚æ¢å¾©ä¸»é¡Œè¨­å®š')
        html.append('try {')
        html.append('  const savedTheme = localStorage.getItem("timeline_theme");')
        html.append('  if (savedTheme === "light") {')
        html.append('    document.body.classList.add("light-theme");')
        html.append('    document.getElementById("themeToggle").textContent = "ğŸŒ™ æ·±è‰²æ¨¡å¼";')
        html.append('  }')
        html.append('} catch(e) {}')
        html.append('')
        html.append('const q=document.getElementById("q");')
        html.append('q.addEventListener("input",()=>{const v=q.value.toLowerCase();document.querySelectorAll("#tbl tbody tr").forEach(tr=>{tr.style.display=tr.innerText.toLowerCase().includes(v)?"":"none";});});')
        # å¾ JSON script tag è®€å–äº‹ä»¶
        html.append("const data = JSON.parse(document.getElementById('events-data').textContent);")
        html.append('const fileView=document.getElementById("file-view");')
        html.append('function renderFileView(file){')
        html.append('  try {')
        html.append('    const fileView = document.getElementById("file-view");')
        html.append('    if (!fileView) {')
        html.append('      console.error("æ‰¾ä¸åˆ°file-viewå…ƒç´ ");')
        html.append('      return;')
        html.append('    }')
        html.append('    const evts=data.filter(e=> (e.file||"")==file).sort((a,b)=> (a.timestamp<b.timestamp?1:-1));')
        html.append('    if(!evts.length){fileView.style.display="none";fileView.innerHTML="";return;}')
        html.append('    fileView.style.display="block";')
        html.append('    try{ fileView.setAttribute("data-current-file", file); }catch(e){}')
        html.append('    let html="<div class=\\\"controls\\\"><div><b>æª”æ¡ˆï¼š</b>"+file+"</div>";')
        html.append('    html+="<div style=\\\"margin-top:10px\\\"><label><input type=\\\"checkbox\\\" id=\\\"autoSizeColumns\\\" checked> è‡ªé©æ‡‰çŸ­æ¬„ä½å¯¬åº¦</label> <span class=\\\"muted\\\">(åƒ…é©ç”¨æ–¼å·¥ä½œè¡¨ã€ä½ç½®ç­‰çŸ­æ¬„ä½ï¼Œå…¬å¼å’Œå€¼æ¬„ä½ç¸½æ˜¯æ›è¡Œ)</span></div>";')
        html.append('  // æ‰¾å‡ºæ‰€æœ‰ä½œè€…å’Œå·¥ä½œè¡¨')
        html.append('  const allAuthors = new Set();')
        html.append('  const allWorksheets = new Set();')
        html.append('  const earliestTime = evts[evts.length-1].timestamp;')
        html.append('  const latestTime = evts[0].timestamp;')
        html.append('  let totalChanges = 0;')
        html.append('  evts.forEach(e => {')
        html.append('    if(e.author) allAuthors.add(e.author);')
        html.append('    totalChanges += parseInt(e.changes || 0);')
        html.append('    (e.diffs || []).forEach(d => {')
        html.append('      if(d.worksheet) allWorksheets.add(d.worksheet);')
        html.append('    });')
        html.append('  });')
        html.append('  html+="<div class=\\\"controls\\\"><div><button id=\\\"byTime\\\">ä¾äº‹ä»¶æ™‚é–“</button> <button id=\\\"byAddr\\\">ä¾ Address</button> <button id=\\\"byAuthor\\\">ä¾ä½œè€…</button> <button id=\\\"exportCSV\\\" class=\\\"export-btn\\\">åŒ¯å‡º CSV</button></div>";')
        html.append('  html+="<div class=\\\"column-controls\\\" style=\\\"margin-top:10px\\\">é¡¯ç¤ºæ¬„ä½: "+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"time\\\" checked> æ™‚é–“</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"author\\\" checked> ä½œè€…</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"worksheet\\\" checked> å·¥ä½œè¡¨</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"address\\\" checked> ä½ç½®</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"oldvalue\\\" checked> åŸå§‹å€¼</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"newvalue\\\" checked> è®Šæ›´å¾Œå€¼</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"valuediff\\\" checked> å€¼å·®ç•°</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"oldformula\\\" checked> åŸå§‹å…¬å¼</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"newformula\\\" checked> è®Šæ›´å¾Œå…¬å¼</label>"+')
        html.append('         "<label class=\\\"column-toggle\\\"><input type=\\\"checkbox\\\" class=\\\"col-toggle\\\" data-col=\\\"formuladiff\\\" checked> å…¬å¼å·®ç•°æ¯”è¼ƒ</label>"+')
        html.append('         "</div>";')
        html.append('  html+="<div class=\\\"filters-container\\\"><div id=\\\"authorFilter\\\" class=\\\"author-filter\\\"></div><div id=\\\"worksheetFilter\\\" class=\\\"worksheet-filter\\\"></div></div>";')
        html.append('  html+="<div id=\\\"summary\\\" class=\\\"summary-box\\\"></div>";')
        html.append('  html+="</div>";')
        html.append('  ')
        html.append('  // å…¨å±€å‡½æ•¸ï¼šè™•ç†å…¬å¼é¡¯ç¤ºï¼Œç§»é™¤å¤šé¤˜çš„è½‰ç¾©å­—ç¬¦')
        html.append('  function formatFormula(formula) {')
        html.append('    if (formula === undefined || formula === null) return "";')
        html.append('    let str = String(formula);')
        html.append('    // ç§»é™¤ JSON è½‰ç¾©å­—ç¬¦ï¼Œè®“å…¬å¼æ›´æ˜“è®€')
        html.append('    str = str.replace(/\\\\"/g, \'"\');')
        html.append('    str = str.replace(/\\\\\\\\/g, \'\\\\\');')
        html.append('    str = str.replace(/\\\\&/g, "&");')
        html.append('    // è™•ç† HTML å¯¦é«”')
        html.append('    str = str.replace(/&/g, "&amp;");')
        html.append('    str = str.replace(/</g, "&lt;");')
        html.append('    str = str.replace(/>/g, "&gt;");')
        html.append('    return str;')
        html.append('  }')
        html.append('  ')
        html.append('  // å…¨å±€å‡½æ•¸ï¼šè™•ç†æ•¸å€¼é¡¯ç¤ºï¼Œç§»é™¤ä¸å¿…è¦çš„å¼•è™Ÿ')
        html.append('  function formatValue(value) {')
        html.append('    if (value === undefined || value === null) return "";')
        html.append('    ')
        html.append('    // å¦‚æœæ˜¯æ•¸å­—ï¼Œç›´æ¥é¡¯ç¤ºï¼Œä¸åŠ å¼•è™Ÿ')
        html.append('    const num = parseFloat(value);')
        html.append('    if (!isNaN(num)) {')
        html.append('      return roundTo(num).toString();')
        html.append('    }')
        html.append('    ')
        html.append('    // å¦‚æœæ˜¯å­—ä¸²ï¼Œåªæœ‰åœ¨å¿…è¦æ™‚æ‰åŠ å¼•è™Ÿï¼ˆåŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ï¼‰')
        html.append('    const str = String(value);')
        html.append('    if (str === "" || /[\\s<>&"\\\'\\\\]/.test(str)) {')
        html.append('      // éœ€è¦å¼•è™Ÿçš„æƒ…æ³ï¼šç©ºå­—ä¸²ã€åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦')
        html.append('      return JSON.stringify(str);')
        html.append('    }')
        html.append('    ')
        html.append('    // æ™®é€šå­—ä¸²ç›´æ¥é¡¯ç¤º')
        html.append('    return str;')
        html.append('  }')
        html.append('  ')
        html.append('  // å…¨å±€ï¼šå°æ•¸ä½è¨­å®šï¼ˆlocalStorageï¼‰èˆ‡å››æ¨äº”å…¥å·¥å…·')
        html.append('  const DEC_KEY = "timeline_decimals";')
        html.append('  function getDecimalsSetting(){')
        html.append('    try{ const v = parseInt(localStorage.getItem(DEC_KEY)||"" ); if(!Number.isNaN(v)) return Math.min(Math.max(v,0),10);}catch(e){}')
        html.append('    const inp = document.getElementById("decimals");')
        html.append('    if (inp){ const vv = parseInt(inp.value); if(!Number.isNaN(vv)) return Math.min(Math.max(vv,0),10);}')
        html.append('    return null;')
        html.append('  }')
        html.append('  function roundTo(n){')
        html.append('    const dec = getDecimalsSetting();')
        html.append('    if (dec===null) return n;')
        html.append('    const f = Math.pow(10, dec);')
        html.append('    return Math.round(n * f) / f;')
        html.append('  }')
        html.append('  // å…¨å±€å‡½æ•¸ï¼šæ¯”è¼ƒå…©å€‹å…¬å¼ä¸¦ç”Ÿæˆå¸¶æœ‰é¡è‰²æ¨™è¨˜çš„ diff HTML (æ”¹é€²ç‰ˆ)')
        html.append('  function formatFormulaDiff(oldFormula, newFormula) {')
        html.append('    const oldStr = formatFormula(oldFormula);')
        html.append('    const newStr = formatFormula(newFormula);')
        html.append('    ')
        html.append('    // å¦‚æœå…©å€‹å…¬å¼ç›¸åŒï¼Œç›´æ¥è¿”å›')
        html.append('    if (oldStr === newStr) {')
        html.append('      return "<span class=\\"formula-diff-unchanged\\">" + oldStr + "</span>";')
        html.append('    }')
        html.append('    ')
        html.append('    // æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å€¼æ¯”è¼ƒ')
        html.append('    const oldNum = parseFloat(oldStr);')
        html.append('    const newNum = parseFloat(newStr);')
        html.append('    ')
        html.append('    if (!isNaN(oldNum) && !isNaN(newNum)) {')
        html.append('      // æ•¸å€¼æ¯”è¼ƒï¼šé¡¯ç¤ºå·®å€¼')
        html.append('      const diff = newNum - oldNum;')
        html.append('      let diffStr = "";')
        html.append('      if (diff > 0) {')
        html.append('        diffStr = `<span style="color: #28a745; font-weight: bold;">+${diff.toLocaleString()}</span>`;')
        html.append('      } else if (diff < 0) {')
        html.append('        diffStr = `<span style="color: #dc3545; font-weight: bold;">${diff.toLocaleString()}</span>`;')
        html.append('      } else {')
        html.append('        diffStr = `<span style="color: #6c757d;">0</span>`;')
        html.append('      }')
        html.append('      return `<span class="formula-diff-deleted">${oldStr}</span> â†’ <span class="formula-diff-added">${newStr}</span><small style="margin-left:6px;opacity:.8">(å·®å€¼: ${diffStr})</small>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // æª¢æŸ¥æ˜¯å¦ç‚ºå…¬å¼')
        html.append('    const oldIsFormula = oldStr.startsWith("=");')
        html.append('    const newIsFormula = newStr.startsWith("=");')
        html.append('    ')
        html.append('    if (oldIsFormula && newIsFormula) {')
        html.append('      // å…¬å¼æ¯”è¼ƒï¼šå€å¡Šç´šåˆ¥å·®ç•°')
        html.append('      return formatBlockLevelFormulaDiff(oldStr, newStr);')
        html.append('    } else if (oldIsFormula !== newIsFormula) {')
        html.append('      // ä¸€å€‹æ˜¯å…¬å¼ä¸€å€‹ä¸æ˜¯ï¼šä¸¦åˆ—é¡¯ç¤º')
        html.append('      return `<span class="formula-diff-deleted">${oldStr}</span> <span class="formula-diff-added">${newStr}</span>`;')
        html.append('    } else {')
        html.append('      // æ–‡å­—æ¯”è¼ƒï¼šæ”¹é€²çš„æ–‡å­—å·®ç•°')
        html.append('      return formatTextDiff(oldStr, newStr);')
        html.append('    }')
        html.append('  }')
        html.append('  ')
        html.append('  // å€å¡Šç´šåˆ¥å…¬å¼å·®ç•°')
        html.append('  function formatBlockLevelFormulaDiff(oldFormula, newFormula) {')
        html.append('    // æå–ä¸»è¦å‡½æ•¸åç¨±')
        html.append('    const oldFunc = extractMainFunction(oldFormula);')
        html.append('    const newFunc = extractMainFunction(newFormula);')
        html.append('    ')
        html.append('    if (oldFunc !== newFunc) {')
        html.append('      // ä¸åŒå‡½æ•¸ï¼šä¸¦åˆ—é¡¯ç¤º')
        html.append('      return `<span class="formula-diff-deleted">${oldFormula}</span> <span class="formula-diff-added">${newFormula}</span>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // ç›¸åŒå‡½æ•¸ï¼šå˜—è©¦åƒæ•¸ç´šåˆ¥æ¯”è¼ƒ')
        html.append('    const oldParams = extractFormulaParameters(oldFormula);')
        html.append('    const newParams = extractFormulaParameters(newFormula);')
        html.append('    ')
        html.append('    if (oldParams.length !== newParams.length) {')
        html.append('      // åƒæ•¸æ•¸é‡ä¸åŒï¼šä¸¦åˆ—é¡¯ç¤º')
        html.append('      return `<span class="formula-diff-deleted">${oldFormula}</span> <span class="formula-diff-added">${newFormula}</span>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // åƒæ•¸ç´šåˆ¥æ¯”è¼ƒ')
        html.append('    let result = `=${oldFunc}(`;')
        html.append('    let hasChanges = false;')
        html.append('    ')
        html.append('    for (let i = 0; i < oldParams.length; i++) {')
        html.append('      if (i > 0) result += ", ";')
        html.append('      ')
        html.append('      if (oldParams[i] === newParams[i]) {')
        html.append('        result += `<span class="formula-diff-unchanged">${oldParams[i]}</span>`;')
        html.append('      } else {')
        html.append('        hasChanges = true;')
        html.append('        result += `<span class="formula-diff-deleted">${oldParams[i]}</span><span class="formula-diff-added">${newParams[i]}</span>`;')
        html.append('      }')
        html.append('    }')
        html.append('    ')
        html.append('    result += ")";')
        html.append('    ')
        html.append('    return hasChanges ? result : oldFormula;')
        html.append('  }')
        html.append('  ')
        html.append('  // æå–ä¸»è¦å‡½æ•¸åç¨±')
        html.append('  function extractMainFunction(formula) {')
        html.append('    const match = formula.match(/^=\\s*([A-Z_]+)\\s*\\(/i);')
        html.append('    return match ? match[1].toUpperCase() : "";')
        html.append('  }')
        html.append('  ')
        html.append('  // æå–å…¬å¼åƒæ•¸')
        html.append('  function extractFormulaParameters(formula) {')
        html.append('    const match = formula.match(/^=\\s*[A-Z_]+\\s*\\((.*)\\)\\s*$/i);')
        html.append('    if (!match) return [];')
        html.append('    ')
        html.append('    const paramStr = match[1];')
        html.append('    if (!paramStr.trim()) return [];')
        html.append('    ')
        html.append('    // ç°¡å–®åˆ†å‰²ï¼ˆä¸è™•ç†åµŒå¥—æ‹¬è™Ÿï¼‰')
        html.append('    return paramStr.split(",").map(p => p.trim());')
        html.append('  }')
        html.append('  ')
        html.append('  // æ”¹é€²çš„æ–‡å­—å·®ç•°')
        html.append('  function formatTextDiff(oldText, newText) {')
        html.append('    if (oldText === newText) {')
        html.append('      return `<span class="formula-diff-unchanged">${oldText}</span>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // è¨ˆç®—ç›¸ä¼¼åº¦')
        html.append('    const similarity = calculateSimilarity(oldText, newText);')
        html.append('    ')
        html.append('    if (similarity < 0.3) {')
        html.append('      // å·®ç•°å¤ªå¤§ï¼šä¸¦åˆ—é¡¯ç¤º')
        html.append('      return `<span class="formula-diff-deleted">${oldText}</span> <span class="formula-diff-added">${newText}</span>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // å–®è©ç´šåˆ¥å·®ç•°')
        html.append('    return formatWordLevelDiff(oldText, newText);')
        html.append('  }')
        html.append('  ')
        html.append('  // è¨ˆç®—æ–‡å­—ç›¸ä¼¼åº¦')
        html.append('  function calculateSimilarity(str1, str2) {')
        html.append('    const longer = str1.length > str2.length ? str1 : str2;')
        html.append('    const shorter = str1.length > str2.length ? str2 : str1;')
        html.append('    ')
        html.append('    if (longer.length === 0) return 1.0;')
        html.append('    ')
        html.append('    const editDistance = levenshteinDistance(longer, shorter);')
        html.append('    return (longer.length - editDistance) / longer.length;')
        html.append('  }')
        html.append('  ')
        html.append('  // è¨ˆç®—ç·¨è¼¯è·é›¢')
        html.append('  function levenshteinDistance(str1, str2) {')
        html.append('    const matrix = [];')
        html.append('    ')
        html.append('    for (let i = 0; i <= str2.length; i++) {')
        html.append('      matrix[i] = [i];')
        html.append('    }')
        html.append('    ')
        html.append('    for (let j = 0; j <= str1.length; j++) {')
        html.append('      matrix[0][j] = j;')
        html.append('    }')
        html.append('    ')
        html.append('    for (let i = 1; i <= str2.length; i++) {')
        html.append('      for (let j = 1; j <= str1.length; j++) {')
        html.append('        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {')
        html.append('          matrix[i][j] = matrix[i - 1][j - 1];')
        html.append('        } else {')
        html.append('          matrix[i][j] = Math.min(')
        html.append('            matrix[i - 1][j - 1] + 1,')
        html.append('            matrix[i][j - 1] + 1,')
        html.append('            matrix[i - 1][j] + 1')
        html.append('          );')
        html.append('        }')
        html.append('      }')
        html.append('    }')
        html.append('    ')
        html.append('    return matrix[str2.length][str1.length];')
        html.append('  }')
        html.append('  ')
        html.append('  // å–®è©ç´šåˆ¥å·®ç•°')
        html.append('  function formatWordLevelDiff(oldText, newText) {')
        html.append('    const oldWords = oldText.split(/\\s+/);')
        html.append('    const newWords = newText.split(/\\s+/);')
        html.append('    ')
        html.append('    const result = [];')
        html.append('    const maxLen = Math.max(oldWords.length, newWords.length);')
        html.append('    ')
        html.append('    for (let i = 0; i < maxLen; i++) {')
        html.append('      const oldWord = i < oldWords.length ? oldWords[i] : "";')
        html.append('      const newWord = i < newWords.length ? newWords[i] : "";')
        html.append('      ')
        html.append('      if (oldWord === newWord && oldWord !== "") {')
        html.append('        result.push(`<span class="formula-diff-unchanged">${oldWord}</span>`);')
        html.append('      } else {')
        html.append('        if (oldWord !== "") {')
        html.append('          result.push(`<span class="formula-diff-deleted">${oldWord}</span>`);')
        html.append('        }')
        html.append('        if (newWord !== "") {')
        html.append('          result.push(`<span class="formula-diff-added">${newWord}</span>`);')
        html.append('        }')
        html.append('      }')
        html.append('    }')
        html.append('    ')
        html.append('    return result.join(" ");')
        html.append('  }')
        html.append('  ')
        html.append('  // æ™ºèƒ½å¯¬åº¦è¨ˆç®—å‡½æ•¸')
        html.append('  function calculateOptimalWidths(evts) {')
        html.append('    const stats = {')
        html.append('      maxTimeLength: 0,')
        html.append('      maxAuthorLength: 0,')
        html.append('      maxWorksheetLength: 0,')
        html.append('      maxAddressLength: 0,')
        html.append('      maxValueLength: 0,')
        html.append('      maxFormulaLength: 0')
        html.append('    };')
        html.append('    ')
        html.append('    // åˆ†ææ‰€æœ‰æ•¸æ“šæ‰¾å‡ºæœ€å¤§é•·åº¦')
        html.append('    evts.forEach(e => {')
        html.append('      if (e.timestamp) stats.maxTimeLength = Math.max(stats.maxTimeLength, e.timestamp.length);')
        html.append('      if (e.author) stats.maxAuthorLength = Math.max(stats.maxAuthorLength, e.author.length);')
        html.append('      ')
        html.append('      (e.diffs || []).forEach(d => {')
        html.append('        if (d.worksheet) stats.maxWorksheetLength = Math.max(stats.maxWorksheetLength, d.worksheet.length);')
        html.append('        if (d.address) stats.maxAddressLength = Math.max(stats.maxAddressLength, d.address.length);')
        html.append('        ')
        html.append('        const ov = formatFormula(d.old_value);')
        html.append('        const nv = formatFormula(d.new_value);')
        html.append('        // åªç”¨åŸå§‹å€¼èˆ‡è®Šæ›´å¾Œå€¼ä¾†æ±ºå®šå€¼çµ„æ¬„å¯¬ï¼Œå–äºŒè€…è¼ƒé•·è€…')
        html.append('        stats.maxValueLength = Math.max(stats.maxValueLength, ov.length, nv.length);')
        html.append('        ')
        html.append('        const oldFormula = formatFormula(d.old_formula);')
        html.append('        const newFormula = formatFormula(d.new_formula);')
        html.append('        stats.maxFormulaLength = Math.max(stats.maxFormulaLength, oldFormula.length, newFormula.length);')
        html.append('      });')
        html.append('    });')
        html.append('    ')
        html.append('    // è¨ˆç®—æœ€ä½³å¯¬åº¦ï¼ˆä»¥å­—ç¬¦æ•¸ * 8px ä¼°ç®—ï¼‰')
        html.append('    const charWidth = 8;')
        html.append('    const padding = 20;')
        html.append('    ')
        html.append('    // å„ªå…ˆä¿è­‰ formula æ¬„ä½ç©ºé–“ - å…ˆè¨ˆç®— formula éœ€è¦çš„æœ€å°ç©ºé–“')
        html.append('    const availableWidth = window.innerWidth - 100; // ç•™ä¸€äº›é‚Šè·')
        html.append('    const minFormulaWidth = 250; // æ¯å€‹ formula æ¬„ä½æœ€å°‘ 250px')
        html.append('    const totalFormulaWidth = minFormulaWidth * 3; // ä¸‰å€‹ formula æ¬„ä½')
        html.append('    ')
        html.append('    // è¨ˆç®—å…¶ä»–æ¬„ä½å¯ç”¨çš„æœ€å¤§ç©ºé–“')
        html.append('    const remainingForOthers = availableWidth - totalFormulaWidth;')
        html.append('    ')
        html.append('    // å¦‚æœç©ºé–“ä¸å¤ ï¼Œå£“ç¸®å…¶ä»–æ¬„ä½åˆ°æœ€å°å€¼')
        html.append('    const widths = {')
        html.append('      time: remainingForOthers > 400 ? Math.min(Math.max(stats.maxTimeLength * charWidth + padding, 120), 150) : 120,')
        html.append('      author: remainingForOthers > 400 ? Math.min(Math.max(stats.maxAuthorLength * charWidth + padding, 60), 120) : 60,')
        html.append('      worksheet: remainingForOthers > 400 ? Math.min(Math.max(stats.maxWorksheetLength * charWidth + padding, 60), 100) : 60,')
        html.append('      address: remainingForOthers > 400 ? Math.min(Math.max(stats.maxAddressLength * charWidth + padding, 50), 80) : 50,')
        html.append('      value: remainingForOthers > 400 ? Math.min(Math.max(stats.maxValueLength * charWidth + padding, 80), 200) : 80')
        html.append('    };')
        html.append('    ')
        html.append('    // é‡æ–°è¨ˆç®—å¯¦éš›ä½¿ç”¨çš„ç©ºé–“')
        html.append('    const actualUsed = widths.time + widths.author + widths.worksheet + widths.address + (widths.value * 2);')
        html.append('    const actualRemaining = availableWidth - actualUsed;')
        html.append('    ')
        html.append('    // Formula æ¬„ä½å¹³åˆ†å‰©é¤˜ç©ºé–“ï¼Œä½†ä¸å°‘æ–¼æœ€å°å€¼')
        html.append('    const calculatedFormulaWidth = Math.floor(actualRemaining / 3);')
        html.append('    widths.formula = Math.max(calculatedFormulaWidth, minFormulaWidth);')
        html.append('    // Force equal widths inside each group')
        html.append('    widths.valueOld = widths.value;')
        html.append('    widths.valueNew = widths.value;')
        html.append('    widths.valueDiff = widths.value;')
        html.append('    widths.formulaOld = widths.formula;')
        html.append('    widths.formulaNew = widths.formula;')
        html.append('    widths.formulaDiff = widths.formula;')
        html.append('    ')
        html.append('    // æœ€çµ‚ä¿è­·ï¼šå¦‚æœè¨ˆç®—å‡ºçš„ formula å¯¬åº¦å¤ªå°ï¼Œå¼·åˆ¶å£“ç¸®å…¶ä»–æ¬„ä½')
        html.append('    if (widths.formula < minFormulaWidth) {')
        html.append('      // æ¥µç«¯æƒ…æ³ï¼šå¼·åˆ¶çµ¦ formula æœ€å°ç©ºé–“ï¼Œå…¶ä»–æ¬„ä½ç”¨æœ€å°å€¼')
        html.append('      widths.time = 100;')
        html.append('      widths.author = 50;')
        html.append('      widths.worksheet = 50;')
        html.append('      widths.address = 40;')
        html.append('      widths.value = 60;')
        html.append('      widths.formula = minFormulaWidth;')
        html.append('      console.warn("æ¥µå°è¢å¹•æ¨¡å¼ï¼šå¼·åˆ¶å£“ç¸®å…¶ä»–æ¬„ä½ä»¥ä¿è­‰ formula ç©ºé–“");')
        html.append('    }')
        html.append('    ')
        html.append('    console.log("Width calculation:", {')
        html.append('      availableWidth: availableWidth,')
        html.append('      actualUsed: actualUsed,')
        html.append('      formulaWidth: widths.formula,')
        html.append('      totalFormulaSpace: widths.formula * 3,')
        html.append('      guaranteedEqual: "ä¸‰å€‹ formula æ¬„ä½å¯¬åº¦ç›¸ç­‰"')
        html.append('    });')
        html.append('    ')
        html.append('    return widths;')
        html.append('  }')
        html.append('  ')
        html.append('  // æ‡‰ç”¨å‹•æ…‹å¯¬åº¦åˆ°è¡¨æ ¼')
        html.append('  function applyDynamicWidths(evts) {')
        html.append('    const widths = calculateOptimalWidths(evts);')
        html.append('    ')
        html.append('    // å‰µå»º CSS è¦å‰‡')
        html.append('    const style = document.createElement("style");')
        html.append('    style.textContent = ')
        html.append('      ".diff-table .col-time { width: " + widths.time + "px !important; }" +')
        html.append('      ".diff-table .col-author { width: " + widths.author + "px !important; }" +')
        html.append('      ".diff-table .col-worksheet { width: " + widths.worksheet + "px !important; }" +')
        html.append('      ".diff-table .col-address { width: " + widths.address + "px !important; }" +')
        html.append('      ".diff-table .col-event { width: 60px !important; }" +')
        html.append('      ".diff-table .col-oldvalue, .diff-table .col-newvalue, .diff-table .col-valuediff { width: " + widths.value + "px !important; min-width: " + widths.value + "px !important; max-width: " + widths.value + "px !important; }" +')
        html.append('      ".diff-table .col-oldformula, .diff-table .col-newformula, .diff-table .col-formuladiff { width: " + widths.formula + "px !important; min-width: " + widths.formula + "px !important; max-width: " + widths.formula + "px !important; }";')
        html.append('    ')
        html.append('    // ç§»é™¤èˆŠçš„å‹•æ…‹æ¨£å¼')
        html.append('    const oldStyle = document.getElementById("dynamic-widths");')
        html.append('    if (oldStyle) oldStyle.remove();')
        html.append('    ')
        html.append('    // æ·»åŠ æ–°æ¨£å¼')
        html.append('    style.id = "dynamic-widths";')
        html.append('    document.head.appendChild(style);')
        html.append('    ')
        html.append('    console.log("Applied dynamic widths:", widths);')
        html.append('  }')
        html.append('  ')
        html.append('  function rowDiff(d, timestamp, author){')
        html.append('    timestamp = timestamp || "";')
        html.append('    author = author || "";')
        html.append('    ')
        html.append('    // è¨ˆç®—å€¼å·®ç•°')
        html.append('    const valueDiff = calculateValueDifference(d.old_value, d.new_value);')
        html.append('    ')
        html.append('    return "<tr>"+')
        html.append('           "<td class=\\\"col-time\\\">"+timestamp+"</td>"+')
        html.append('           "<td class=\\\"col-author\\\">"+author+"</td>"+')
        html.append('           "<td class=\\\"col-worksheet\\\">"+(d.worksheet||"")+"</td>"+')
        html.append('           "<td class=\\\"col-address\\\">"+(d.address||"")+"</td>"+')
        html.append('           "<td class=\\\"col-oldvalue\\\">"+formatValue(d.old_value)+"</td>"+')
        html.append('           "<td class=\\\"col-newvalue\\\">"+formatValue(d.new_value)+"</td>"+')
        html.append('           "<td class=\\\"col-valuediff\\\">"+valueDiff+"</td>"+')
        html.append('           "<td class=\\\"col-oldformula formula-cell\\\">"+formatFormula(d.old_formula)+"</td>"+')
        html.append('           "<td class=\\\"col-newformula formula-cell\\\">"+formatFormula(d.new_formula)+"</td>"+')
        html.append('           "<td class=\\\"col-formuladiff formula-cell\\\">"+formatFormulaDiff(d.old_formula, d.new_formula)+"</td>"+')
        html.append('           "</tr>";')
        html.append('  }')
        html.append('  ')
        html.append('  // è¨ˆç®—å€¼å·®ç•°')
        html.append('  function calculateValueDifference(oldValue, newValue) {')
        html.append('    // å¦‚æœå€¼ç›¸åŒï¼Œè¿”å›ç„¡è®ŠåŒ–')
        html.append('    if (oldValue === newValue) {')
        html.append('      return `<span style="color: #6c757d; font-style: italic;">ç„¡è®ŠåŒ–</span>`;')
        html.append('    }')
        html.append('    ')
        html.append('    // å˜—è©¦è½‰æ›ç‚ºæ•¸å­—')
        html.append('    const oldNum = parseFloat(oldValue);')
        html.append('    const newNum = parseFloat(newValue);')
        html.append('    ')
        html.append('    if (!isNaN(oldNum) && !isNaN(newNum)) {')
        html.append('      // æ•¸å€¼å·®ç•°')
        html.append('      const diff = roundTo(newNum - oldNum);')
        html.append('      if (diff > 0) {')
        html.append('        return `<span style="color: #28a745; font-weight: bold;">+${diff}</span>`;')
        html.append('      } else if (diff < 0) {')
        html.append('        return `<span style="color: #dc3545; font-weight: bold;">${diff}</span>`;')
        html.append('      } else {')
        html.append('        return `<span style="color: #6c757d;">0</span>`;')
        html.append('      }')
        html.append('    } else {')
        html.append('      // æ–‡å­—å·®ç•°')
        html.append('      return formatTextDiff(String(oldValue || ""), String(newValue || ""));')
        html.append('    }')
        html.append('  }')
        html.append('  function viewByTime(){')
        html.append('    let s="<h4>ä¾äº‹ä»¶æ™‚é–“</h4>";')
        html.append('    evts.forEach(e=>{')
        html.append('      s+="<div style=\\"margin:6px 0;padding:6px;border:1px solid #ddd\\">";')
        html.append('      s+="<div><b>äº‹ä»¶#"+(e.event_number||"")+"</b> | "+e.timestamp+" | è®Šæ›´æ•¸ "+(e.changes||"")+" | "+(e.author||"")+"</div>";')
        html.append('      const diffs=e.diffs||[];')
        html.append('      if(diffs.length){')
        html.append('        s+="<table style=\\"margin-top:4px\\" class=\\"diff-table\\"><thead><tr>"+')
        html.append('          "<th class=\\"col-time\\">æ™‚é–“</th>"+')
        html.append('          "<th class=\\"col-author\\">ä½œè€…</th>"+')
        html.append('          "<th class=\\"col-worksheet\\">å·¥ä½œè¡¨</th>"+')
        html.append('          "<th class=\\"col-address\\">ä½ç½®</th>"+')
        html.append('          "<th class=\\"col-oldvalue\\">åŸå§‹å€¼</th>"+')
        html.append('          "<th class=\\"col-newvalue\\">è®Šæ›´å¾Œå€¼</th>"+')
        html.append('          "<th class=\\"col-valuediff\\">å€¼å·®ç•°</th>"+')
        html.append('          "<th class=\\\"col-oldformula\\\">åŸå§‹å…¬å¼</th>"+')
        html.append('          "<th class=\\\"col-newformula\\\">è®Šæ›´å¾Œå…¬å¼</th>"+')
        html.append('          "<th class=\\\"col-formuladiff\\\">å…¬å¼å·®ç•°æ¯”è¼ƒ</th>"+')
        html.append('          "</tr></thead><tbody>";')
        html.append('        diffs.forEach(d=>{s+=rowDiff(d, e.timestamp, e.author)});')
        html.append('        s+="</tbody></table>";')
        html.append('      }else{ s+="<div class=muted>(ç„¡ç²¾ç°¡å·®ç•°ï¼Œè«‹é–‹ per-event)</div>"; }')
        html.append('      s+="</div>";')
        html.append('    });')
        html.append('    fileView.innerHTML=html+s;')
        html.append('    // æ‡‰ç”¨å‹•æ…‹å¯¬åº¦')
        html.append('    applyDynamicWidths(evts);')
        html.append('    document.getElementById("byTime").onclick=viewByTime;')
        html.append('    document.getElementById("byAddr").onclick=viewByAddr;')
        html.append('    document.getElementById("byAuthor").onclick=viewByAuthor;')
        html.append('    document.getElementById("exportCSV").onclick=exportToCSV;')
        html.append('    setupControlEvents();')
        html.append('  }')
        html.append('  function viewByAddr(){')
        html.append('    try {')
        html.append('      console.log("viewByAddr function called");')
        html.append('      let s="<h4>ä¾ Address</h4>";')
        html.append('      const bag={};')
        html.append('    evts.forEach(e => {')
        html.append('      (e.diffs || []).forEach(d => {')
        html.append('        const k = (d.address || "") + "@" + (d.worksheet || "");')
        html.append('        (bag[k] || (bag[k] = [])).push({')
        html.append('          evt: e.event_number,')
        html.append('          ts: e.timestamp,')
        html.append('          author: e.author,')
        html.append('          worksheet: d.worksheet,')
        html.append('          address: d.address,')
        html.append('          old: d.old_value,')
        html.append('          new: d.new_value,')
        html.append('          old_formula: d.old_formula,')
        html.append('          new_formula: d.new_formula')
        html.append('        });')
        html.append('      });')
        html.append('    });')
        html.append('    const keys=Object.keys(bag).sort();')
        html.append('    keys.forEach(k=>{ ')
        html.append('      // è§£æåœ°å€å’Œå·¥ä½œè¡¨')
        html.append('      const parts = k.split("@");')
        html.append('      const address = parts[0] || "";')
        html.append('      const sheet = parts[1] || "";')
        html.append('      s+="<div style=\\"margin:6px 0;padding:6px;border:1px solid #ddd\\"><div><b>åœ°å€: "+address+"</b> <span class=\\"muted\\">(å·¥ä½œè¡¨: "+sheet+")</span></div>";')
        html.append('      s+="<table style=\\"margin-top:4px\\" class=\\"diff-table\\"><thead><tr>"+')
        html.append('        "<th class=\\"col-event\\">äº‹ä»¶#</th>"+')
        html.append('        "<th class=\\"col-time\\">æ™‚é–“</th>"+')
        html.append('        "<th class=\\"col-author\\">ä½œè€…</th>"+')
        html.append('        "<th class=\\"col-worksheet\\">å·¥ä½œè¡¨</th>"+')
        html.append('        "<th class=\\"col-address\\">ä½ç½®</th>"+')
        html.append('        "<th class=\\"col-oldvalue\\">åŸå§‹å€¼</th>"+')
        html.append('        "<th class=\\"col-newvalue\\">è®Šæ›´å¾Œå€¼</th>"+')
        html.append('        "<th class=\\"col-valuediff\\">å€¼å·®ç•°</th>"+')
        html.append('        "<th class=\\\"col-oldformula\\\">åŸå§‹å…¬å¼</th>"+')
        html.append('        "<th class=\\\"col-newformula\\\">è®Šæ›´å¾Œå…¬å¼</th>"+')
        html.append('        "<th class=\\\"col-formuladiff\\\">å…¬å¼å·®ç•°æ¯”è¼ƒ</th>"+')
        html.append('        "</tr></thead><tbody>";')
        html.append('      bag[k].sort((a,b)=> (a.ts<b.ts?1:-1)).forEach(r=>{ s+="<tr>"+')
        html.append('        "<td class=\\\"col-event\\\">"+(r.evt||"")+"</td>"+')
        html.append('        "<td class=\\\"col-time\\\">"+r.ts+"</td>"+')
        html.append('        "<td class=\\\"col-author author-cell\\\">"+(r.author||"")+"</td>"+')
        html.append('        "<td class=\\\"col-worksheet\\\">"+(r.worksheet||"")+"</td>"+')
        html.append('        "<td class=\\\"col-address\\\">"+(r.address||"")+"</td>"+')
        html.append('        "<td class=\\\"col-oldvalue\\\">"+formatValue(r.old)+"</td>"+')
        html.append('        "<td class=\\\"col-newvalue\\\">"+formatValue(r.new)+"</td>"+')
        html.append('        "<td class=\\\"col-valuediff\\\">"+calculateValueDifference(r.old, r.new)+"</td>"+')
        html.append('        "<td class=\\\"col-oldformula formula-cell\\\">"+formatFormula(r.old_formula)+"</td>"+')
        html.append('        "<td class=\\\"col-newformula formula-cell\\\">"+formatFormula(r.new_formula)+"</td>"+')
        html.append('        "<td class=\\\"col-formuladiff formula-cell\\\">"+formatFormulaDiff(r.old_formula, r.new_formula)+"</td>"+')
        html.append('        "</tr>"; });')
        html.append('      s+="</tbody></table></div>";')
        html.append('    });')
        html.append('    fileView.innerHTML=html+s;')
        html.append('    // æ‡‰ç”¨å‹•æ…‹å¯¬åº¦')
        html.append('    applyDynamicWidths(evts);')
        html.append('    document.getElementById("byTime").onclick=viewByTime;')
        html.append('    document.getElementById("byAddr").onclick=viewByAddr;')
        html.append('    document.getElementById("byAuthor").onclick=viewByAuthor;')
        html.append('    document.getElementById("exportCSV").onclick=exportToCSV;')
        html.append('    setupControlEvents();')
        html.append('    } catch (e) {')
        html.append('      console.error("viewByAddr function error:", e);')
        html.append('      alert("Address è¦–åœ–ç™¼ç”ŸéŒ¯èª¤: " + e.message);')
        html.append('    }')
        html.append('  }')
        html.append('  function viewByAuthor(){')
        html.append('    let s="<h4>ä¾ä½œè€…</h4>";')
        html.append('    const authorBag = {};')
        html.append('    evts.forEach(e => {')
        html.append('      const author = e.author || "æœªçŸ¥";')
        html.append('      if (!authorBag[author]) authorBag[author] = [];')
        html.append('      authorBag[author].push(e);')
        html.append('    });')
        html.append('    const authorList = Object.keys(authorBag).sort();')
        html.append('    authorList.forEach(author => {')
        html.append('      const authorEvents = authorBag[author];')
        html.append('      s += "<div style=\\"margin:10px 0;padding:10px;border:1px solid #ddd\\"><h4>" + author + " (" + authorEvents.length + " æ¬¡è®Šæ›´)</h4>";')
        html.append('      authorEvents.sort((a,b) => a.timestamp < b.timestamp ? 1 : -1);')
        html.append('      authorEvents.forEach(e => {')
        html.append('        s += "<div style=\\"margin:6px 0;padding:6px;border:1px solid #eee\\">";')
        html.append('        s += "<div><b>äº‹ä»¶#" + (e.event_number || "") + "</b> | " + e.timestamp + " | è®Šæ›´æ•¸ " + (e.changes || "") + "</div>";')
        html.append('        // è¨˜éŒ„ä½œè€…å’Œæ™‚é–“ï¼Œä»¥ä¾¿åœ¨é¡¯ç¤ºæ™‚ä½¿ç”¨')
        html.append('        const author = e.author || "";')
        html.append('        const timestamp = e.timestamp || "";')
        html.append('        const diffs = e.diffs || [];')
        html.append('        if(diffs.length) {')
        html.append('          s += "<table style=\\"margin-top:4px\\" class=\\"diff-table\\"><thead><tr>" +')
        html.append('                "<th class=\\"col-time\\">æ™‚é–“</th>" +')
        html.append('                "<th class=\\"col-author\\">ä½œè€…</th>" +')
        html.append('                "<th class=\\"col-worksheet\\">å·¥ä½œè¡¨</th>" +')
        html.append('                "<th class=\\"col-address\\">ä½ç½®</th>" +')
        html.append('                "<th class=\\"col-oldvalue\\">åŸå§‹å€¼</th>" +')
        html.append('                "<th class=\\"col-newvalue\\">è®Šæ›´å¾Œå€¼</th>" +')
        html.append('                "<th class=\\"col-valuediff\\">å€¼å·®ç•°</th>" +')
        html.append('                "<th class=\\\"col-oldformula\\\">åŸå§‹å…¬å¼</th>" +')
        html.append('                "<th class=\\\"col-newformula\\\">è®Šæ›´å¾Œå…¬å¼</th>" +')
        html.append('                "<th class=\\\"col-formuladiff\\\">å…¬å¼å·®ç•°æ¯”è¼ƒ</th>" +')
        html.append('                "</tr></thead><tbody>";')
        html.append('          diffs.forEach(d => { s += rowDiff(d, timestamp, author); });')
        html.append('          s += "</tbody></table>";')
        html.append('        } else {')
        html.append('          s += "<div class=muted>(ç„¡ç²¾ç°¡å·®ç•°ï¼Œè«‹é–‹ per-event)</div>";')
        html.append('        }')
        html.append('        s += "</div>";')
        html.append('      });')
        html.append('      s += "</div>";')
        html.append('    });')
        html.append('    fileView.innerHTML = html + s;')
        html.append('    // æ‡‰ç”¨å‹•æ…‹å¯¬åº¦')
        html.append('    applyDynamicWidths(evts);')
        html.append('    document.getElementById("byTime").onclick = viewByTime;')
        html.append('    document.getElementById("byAddr").onclick = viewByAddr;')
        html.append('    document.getElementById("byAuthor").onclick = viewByAuthor;')
        html.append('    document.getElementById("exportCSV").onclick = exportToCSV;')
        html.append('    setupControlEvents();')
        html.append('  }')
        html.append('  // æ›´æ–°æ‘˜è¦ä¿¡æ¯')
        html.append('  function updateSummary() {')
        html.append('    const summaryDiv = document.getElementById("summary");')
        html.append('    if (summaryDiv) {  // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨')
        html.append('      summaryDiv.innerHTML = "<b>æ‘˜è¦ä¿¡æ¯ï¼š</b> " +')
        html.append('        "<span>è¨˜éŒ„æœŸé–“ï¼š" + earliestTime + " è‡³ " + latestTime + "</span>, " +')
        html.append('        "<span>ç¸½è®Šæ›´æ•¸ï¼š" + totalChanges + "</span>, " +')
        html.append('        "<span>ä½œè€…æ•¸ï¼š" + allAuthors.size + "</span>, " +')
        html.append('        "<span>å·¥ä½œè¡¨æ•¸ï¼š" + allWorksheets.size + "</span>";')
        html.append('    }')
        html.append('  }')
        html.append('  // æ›´æ–°ä½œè€…ç¯©é¸å’Œå·¥ä½œè¡¨ç¯©é¸')
        html.append('  function updateFilters() {')
        html.append('    updateAuthorFilter();')
        html.append('    updateWorksheetFilter();')
        html.append('  }')
        html.append('  ')
        html.append('  // æ›´æ–°ä½œè€…ç¯©é¸')
        html.append('  function updateAuthorFilter() {')
        html.append('    const filterDiv = document.getElementById("authorFilter");')
        html.append('    if (filterDiv) {  // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨')
        html.append('      let filterHtml = "<div><b>ä½œè€…ç¯©é¸ï¼š</b> ";')
        html.append('      filterHtml += "<span class=\\"author-tag author-all\\" data-author=\\"all\\">æ‰€æœ‰ä½œè€…</span> ";')
        html.append('      allAuthors.forEach(author => {')
        html.append('        filterHtml += "<span class=\\"author-tag\\" data-author=\\"" + author + "\\">" + author + "</span> ";')
        html.append('      });')
        html.append('      filterHtml += "</div>";')
        html.append('      filterDiv.innerHTML = filterHtml;')
        html.append('      // æ·»åŠ é»æ“Šäº‹ä»¶')
        html.append('      document.querySelectorAll(".author-tag").forEach(tag => {')
        html.append('        tag.addEventListener("click", function() {')
        html.append('          const author = this.getAttribute("data-author");')
        html.append('          highlightAuthor(author);')
        html.append('        });')
        html.append('      });')
        html.append('    }')
        html.append('  }')
        html.append('  ')
        html.append('  // æ›´æ–°å·¥ä½œè¡¨ç¯©é¸')
        html.append('  function updateWorksheetFilter() {')
        html.append('    const filterDiv = document.getElementById("worksheetFilter");')
        html.append('    if (!filterDiv) return;')
        html.append('    ')
        html.append('    let filterHtml = "<div><b>å·¥ä½œè¡¨ç¯©é¸ï¼š</b> ";')
        html.append('    filterHtml += "<span class=\\"worksheet-tag worksheet-all\\" data-worksheet=\\"all\\">æ‰€æœ‰å·¥ä½œè¡¨</span> ";')
        html.append('    allWorksheets.forEach(ws => {')
        html.append('      filterHtml += "<span class=\\"worksheet-tag\\" data-worksheet=\\"" + ws + "\\">" + ws + "</span> ";')
        html.append('    });')
        html.append('    filterHtml += "</div>";')
        html.append('    filterDiv.innerHTML = filterHtml;')
        html.append('    ')
        html.append('    // æ·»åŠ é»æ“Šäº‹ä»¶')
        html.append('    document.querySelectorAll(".worksheet-tag").forEach(tag => {')
        html.append('      tag.addEventListener("click", function() {')
        html.append('        const ws = this.getAttribute("data-worksheet");')
        html.append('        filterWorksheet(ws);')
        html.append('      });')
        html.append('    });')
        html.append('    ')
        html.append('    // é è¨­é¸ä¸­"æ‰€æœ‰å·¥ä½œè¡¨"')
        html.append('    const allTag = document.querySelector(".worksheet-tag.worksheet-all");')
        html.append('    if (allTag) {')
        html.append('      allTag.style.fontWeight = "bold";')
        html.append('      allTag.style.backgroundColor = "#bae7ff";')
        html.append('    }')
        html.append('  }')
        html.append('  // å„²å­˜ç•¶å‰ç¯©é¸ç‹€æ…‹')
        html.append('  let currentAuthorFilter = "all";')
        html.append('  let currentWorksheetFilter = null;')
        html.append('  ')
        html.append('  // é«˜äº®ç‰¹å®šä½œè€…çš„è®Šæ›´')
        html.append('  function highlightAuthor(author) {')
        html.append('    // å„²å­˜ç•¶å‰ä½œè€…ç¯©é¸')
        html.append('    currentAuthorFilter = author;')
        html.append('    ')
        html.append('    // ç§»é™¤æ‰€æœ‰ä½œè€…æ¨™ç±¤çš„é¸ä¸­ç‹€æ…‹')
        html.append('    document.querySelectorAll(".author-tag").forEach(tag => {')
        html.append('      tag.style.fontWeight = "normal";')
        html.append('      tag.style.backgroundColor = "#e6f7ff";')
        html.append('    });')
        html.append('    // é«˜äº®é¸ä¸­çš„ä½œè€…æ¨™ç±¤')
        html.append('    if (author !== "all") {')
        html.append('      const authorTag = document.querySelector(".author-tag[data-author=\\"" + author + "\\"]");')
        html.append('      if (authorTag) {')
        html.append('        authorTag.style.fontWeight = "bold";')
        html.append('        authorTag.style.backgroundColor = "#bae7ff";')
        html.append('      }')
        html.append('    } else {')
        html.append('      const allTag = document.querySelector(".author-tag.author-all");')
        html.append('      if (allTag) {')
        html.append('        allTag.style.fontWeight = "bold";')
        html.append('        allTag.style.backgroundColor = "#bae7ff";')
        html.append('      }')
        html.append('    }')
        html.append('    // é«˜äº®æˆ–é‚„åŸè¡¨æ ¼ä¸­çš„ä½œè€…å–®å…ƒæ ¼')
        html.append('    document.querySelectorAll(".author-cell").forEach(cell => {')
        html.append('      const cellAuthor = cell.textContent;')
        html.append('      cell.parentNode.classList.remove("author-highlight");')
        html.append('      if (author !== "all" && cellAuthor === author) {')
        html.append('        cell.parentNode.classList.add("author-highlight");')
        html.append('      }')
        html.append('    });')
        html.append('  }')
        html.append('  ')
        html.append('  // ç¯©é¸ç‰¹å®šå·¥ä½œè¡¨')
        html.append('  function filterWorksheet(worksheet) {')
        html.append('    // å„²å­˜ç•¶å‰å·¥ä½œè¡¨ç¯©é¸')
        html.append('    currentWorksheetFilter = worksheet === "all" ? null : worksheet;')
        html.append('    ')
        html.append('    // æ›´æ–°å·¥ä½œè¡¨æ¨™ç±¤æ¨£å¼')
        html.append('    document.querySelectorAll(".worksheet-tag").forEach(tag => {')
        html.append('      tag.style.fontWeight = "normal";')
        html.append('      tag.style.backgroundColor = "#e6f7ff";')
        html.append('    });')
        html.append('    ')
        html.append('    // é«˜äº®é¸ä¸­çš„å·¥ä½œè¡¨æ¨™ç±¤')
        html.append('    if (worksheet !== "all") {')
        html.append('      const wsTag = document.querySelector(".worksheet-tag[data-worksheet=\\"" + worksheet + "\\"]");')
        html.append('      if (wsTag) {')
        html.append('        wsTag.style.fontWeight = "bold";')
        html.append('        wsTag.style.backgroundColor = "#bae7ff";')
        html.append('      }')
        html.append('    } else {')
        html.append('      const allTag = document.querySelector(".worksheet-tag.worksheet-all");')
        html.append('      if (allTag) {')
        html.append('        allTag.style.fontWeight = "bold";')
        html.append('        allTag.style.backgroundColor = "#bae7ff";')
        html.append('      }')
        html.append('    }')
        html.append('    ')
        html.append('    // éæ¿¾è¡¨æ ¼è¡Œ')
        html.append('    if (worksheet === "all") {')
        html.append('      // é¡¯ç¤ºæ‰€æœ‰è¡Œ')
        html.append('      document.querySelectorAll("#file-view table.diff-table tbody tr").forEach(row => {')
        html.append('        if (!row.classList.contains("filtered-by-author")) {')
        html.append('          row.style.display = "";')
        html.append('        }')
        html.append('      });')
        html.append('    } else {')
        html.append('      // åªé¡¯ç¤ºç¬¦åˆçš„å·¥ä½œè¡¨')
        html.append('      document.querySelectorAll("#file-view table.diff-table tbody tr").forEach(row => {')
        html.append('        const wsCell = row.querySelector(".col-worksheet");')
        html.append('        if (wsCell) {')
        html.append('          const cellWs = wsCell.textContent;')
        html.append('          if (cellWs === worksheet) {')
        html.append('            if (!row.classList.contains("filtered-by-author")) {')
        html.append('              row.style.display = "";')
        html.append('            }')
        html.append('          } else {')
        html.append('            row.style.display = "none";')
        html.append('          }')
        html.append('        }')
        html.append('      });')
        html.append('    }')
        html.append('  }')
        html.append('  // è¨­ç½®åˆ—é¡¯ç¤ºæ§åˆ¶')
        html.append('  function setupControlEvents() {')
        html.append('    try {')
        html.append('      // æ¬„ä½é¡¯ç¤ºæ§åˆ¶')
        html.append('      const checkboxes = document.querySelectorAll(".col-toggle");')
        html.append('      if (checkboxes && checkboxes.length > 0) {')
        html.append('        checkboxes.forEach(checkbox => {')
        html.append('          if (checkbox) {')
        html.append('            checkbox.addEventListener("change", function() {')
        html.append('              const colClass = "col-" + this.getAttribute("data-col");')
        html.append('              const display = this.checked ? "" : "none";')
        html.append('              document.querySelectorAll("." + colClass).forEach(cell => {')
        html.append('                if (cell) cell.style.display = display;')
        html.append('              });')
        html.append('            });')
        html.append('          }')
        html.append('        });')
        html.append('      }')
        html.append('      ')
        html.append('      // è‡ªé©æ‡‰åˆ—å¯¬åº¦æ§åˆ¶')
        html.append('      const autoSizeCheckbox = document.getElementById("autoSizeColumns");')
        html.append('      if (autoSizeCheckbox) {')
        html.append('        autoSizeCheckbox.addEventListener("change", function() {')
        html.append('          const tables = document.querySelectorAll("#file-view table.diff-table");')
        html.append('          tables.forEach(table => {')
        html.append('            if (this.checked) {')
        html.append('              table.classList.add("auto-size-columns");')
        html.append('            } else {')
        html.append('              table.classList.remove("auto-size-columns");')
        html.append('            }')
        html.append('          });')
        html.append('        });')
        html.append('        // åˆå§‹ç‹€æ…‹')
        html.append('        const tables = document.querySelectorAll("#file-view table.diff-table");')
        html.append('        tables.forEach(table => {')
        html.append('          if (autoSizeCheckbox.checked) {')
        html.append('            table.classList.add("auto-size-columns");')
        html.append('          } else {')
        html.append('            table.classList.remove("auto-size-columns");')
        html.append('          }')
        html.append('        });')
        html.append('      }')
        html.append('    } catch (e) {')
        html.append('      console.error("è¨­ç½®æ§åˆ¶äº‹ä»¶æ™‚å‡ºéŒ¯:", e);')
        html.append('    }')
        html.append('  }')
        html.append('  // åŒ¯å‡ºåˆ°CSV')
        html.append('  function exportToCSV() {')
        html.append('    try {')
        html.append('      console.log("é–‹å§‹åŒ¯å‡ºCSV...");')
        html.append('      let csvContent = "\\uFEFF"; // UTF-8 BOM for Excel')
        html.append('      // æ¨™é¡Œè¡Œ')
        html.append('      csvContent += "æ™‚é–“,äº‹ä»¶#,ä½œè€…,å·¥ä½œè¡¨,ä½ç½®,åŸå§‹å€¼,è®Šæ›´å¾Œå€¼,åŸå§‹å…¬å¼,è®Šæ›´å¾Œå…¬å¼,å…¬å¼å·®ç•°æ¯”è¼ƒ\\r\\n";')
        html.append('      ')
        html.append('      // å–å¾—ç•¶å‰å¯è¦‹çš„è¡¨æ ¼')
        html.append('      console.log("æŸ¥æ‰¾è¡¨æ ¼å…§å®¹...");')
        html.append('      const fileView = document.getElementById("file-view");')
        html.append('      if (!fileView) {')
        html.append('        console.log("æ‰¾ä¸åˆ°file-viewå…ƒç´ ");')
        html.append('        alert("æ‰¾ä¸åˆ°æª”æ¡ˆè¦–åœ–å…ƒç´ ï¼Œè«‹å…ˆé»æ“Šæª”æ¡ˆåç¨±æŸ¥çœ‹è©³æƒ…");')
        html.append('        return;')
        html.append('      }')
        html.append('      // ä½¿ç”¨æ›´å¯¬é¬†çš„é¸æ“‡å™¨')
        html.append('      const tableRows = fileView.querySelectorAll("table tbody tr");')
        html.append('      ')
        html.append('      // å¦‚æœç•¶å‰æœ‰è¡¨æ ¼é¡¯ç¤ºï¼ŒåŒ¯å‡ºè¡¨æ ¼å…§å®¹')
        html.append('      console.log("æ‰¾åˆ°è¡¨æ ¼è¡Œ: " + (tableRows ? tableRows.length : 0));')
        html.append('      // èª¿è©¦ï¼šæŸ¥çœ‹è¡¨æ ¼è¡Œçš„å¯è¦‹æ€§')
        html.append('      if (tableRows && tableRows.length > 0) {')
        html.append('        console.log("è¡¨æ ¼è¡Œè©³æƒ…:");')
        html.append('        Array.from(tableRows).slice(0, 3).forEach((row, idx) => {')
        html.append('          console.log("  è¡Œ " + idx + ": display=" + row.style.display + ", visibility=" + row.style.visibility + ", å…§å®¹é•·åº¦=" + row.innerHTML.length);')
        html.append('        });')
        html.append('        // å¾ç•¶å‰é¡¯ç¤ºçš„è¡¨æ ¼åŒ¯å‡º')
        html.append('        tableRows.forEach(row => {')
        html.append('          // æª¢æŸ¥æ­¤è¡Œæ˜¯å¦è¢«ç¯©é¸éš±è—')
        html.append('          console.log("è™•ç†è¡Œ: display=" + row.style.display + ", visibility=" + row.style.visibility);')
        html.append('          if (row.style.display !== "none") {')
        html.append('            const cells = row.querySelectorAll("td");')
        html.append('            if (cells.length >= 4) {')
        html.append('              // ä¾è¦–åœ–ä¸åŒï¼Œå¯èƒ½æ˜¯æ™‚é–“è¦–åœ–æˆ–åœ°å€è¦–åœ–æˆ–ä½œè€…è¦–åœ–')
        html.append('              // å˜—è©¦æ‰¾åˆ°ç›¸æ‡‰æ¬„ä½')
        html.append('              let time = "", eventNum = "", author = "", worksheet = "", address = "", oldValue = "", newValue = "", oldFormula = "", newFormula = "";')
        html.append('              ')
        html.append('              // æª¢æŸ¥è¦–åœ–é¡å‹ä¸¦ç²å–æ­£ç¢ºçš„æ¬„ä½')
        html.append('              if (row.querySelector(".col-event")) {  // æ™‚é–“è¦–åœ–')
        html.append('                eventNum = cells[0].textContent || "";')
        html.append('                time = cells[1].textContent || "";')
        html.append('                author = cells[2].textContent || "";')
        html.append('                oldValue = cells[3].textContent || "";')
        html.append('                newValue = cells[4].textContent || "";')
        html.append('                oldFormula = cells[5].textContent || "";')
        html.append('                newFormula = cells[6].textContent || "";')
        html.append('              } else if (row.querySelector(".col-worksheet")) {  // åœ°å€è¦–åœ–')
        html.append('                worksheet = cells[0].textContent || "";')
        html.append('                address = cells[1].textContent || "";')
        html.append('                oldValue = cells[2].textContent || "";')
        html.append('                newValue = cells[3].textContent || "";')
        html.append('                oldFormula = cells[4].textContent || "";')
        html.append('                newFormula = cells[5].textContent || "";')
        html.append('                // å¾é é¢ç²å–ç•¶å‰æ–‡ä»¶ä¿¡æ¯')
        html.append('                const fileInfoDiv = document.querySelector("#file-view div b:first-child").parentNode;')
        html.append('                if (fileInfoDiv) {')
        html.append('                  author = currentAuthorFilter !== "all" ? currentAuthorFilter : "";')
        html.append('                }')
        html.append('              }')
        html.append('              ')
        html.append('              // å°‡æ‰€æœ‰å€¼è™•ç†ç‚ºCSVæ ¼å¼')
        html.append('              time = time.replace(/,/g, " ");')
        html.append('              eventNum = eventNum.replace(/,/g, " ");')
        html.append('              author = author.replace(/,/g, " ");')
        html.append('              worksheet = worksheet.replace(/,/g, " ");')
        html.append('              address = address.replace(/,/g, " ");')
        html.append('              oldValue = oldValue.replace(/"/g, "\\\""); // è½‰ç¾©é›™å¼•è™Ÿ')
        html.append('              newValue = newValue.replace(/"/g, "\\\"");')
        html.append('              oldFormula = oldFormula.replace(/"/g, "\\\"");')
        html.append('              newFormula = newFormula.replace(/"/g, "\\\"");')
        html.append('              ')
        html.append('              // æ·»åŠ åˆ°CSV')
        html.append('              csvContent += `${time},${eventNum},${author},${worksheet},${address},"${oldValue}","${newValue}","${oldFormula}","${newFormula}"\\r\\n`;')
        html.append('            }')
        html.append('          }')
        html.append('        });')
        html.append('      } else if (evts && evts.length) {')
        html.append('        // å¦‚æœæ²’æœ‰é¡¯ç¤ºè¡¨æ ¼ä½†æœ‰äº‹ä»¶æ•¸æ“šï¼Œå‰‡åŒ¯å‡ºæ‰€æœ‰äº‹ä»¶')
        html.append('        const filteredEvts = currentWorksheetFilter ? ')
        html.append('          evts.map(e => {')
        html.append('            const filteredDiffs = (e.diffs || []).filter(d => d.worksheet === currentWorksheetFilter);')
        html.append('            return {...e, diffs: filteredDiffs};')
        html.append('          }).filter(e => e.diffs && e.diffs.length > 0) : evts;')
        html.append('        ')
        html.append('        filteredEvts.forEach(e => {')
        html.append('          const diffs = e.diffs || [];')
        html.append('          if(diffs.length) {')
        html.append('            diffs.forEach(d => {')
        html.append('              // æª¢æŸ¥æ˜¯å¦æ‡‰è©²åŒ…å«æ­¤å·¥ä½œè¡¨')
        html.append('              if (!currentWorksheetFilter || d.worksheet === currentWorksheetFilter) {')
        html.append('                let oldVal = formatValue(d.old_value || "").replace(/"/g, "\\\"");')
        html.append('                let newVal = formatValue(d.new_value || "").replace(/"/g, "\\\"");')
        html.append('                let oldForm = JSON.stringify(d.old_formula || "").replace(/"/g, "\\\"");')
        html.append('                let newForm = JSON.stringify(d.new_formula || "").replace(/"/g, "\\\"");')
        html.append('                let diffForm = formatFormulaDiff(d.old_formula, d.new_formula).replace(/<[^>]*>/g, "").replace(/"/g, "\\\"");')
        html.append('                csvContent += (e.timestamp || "") + "," + (e.event_number || "") + "," + (e.author || "") + "," + (d.worksheet || "") + "," + (d.address || "") + ",\\"" + oldVal + "\\",\\"" + newVal + "\\",\\"" + oldForm + "\\",\\"" + newForm + "\\",\\"" + diffForm + "\\"\\r\\n";')
        html.append('              }')
        html.append('            });')
        html.append('          }')
        html.append('        });')
        html.append('      }')
        html.append('      ')
        html.append('      // æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹')
        html.append('      const headerLength = "\\uFEFFæ™‚é–“,äº‹ä»¶#,ä½œè€…,å·¥ä½œè¡¨,ä½ç½®,åŸå§‹å€¼,è®Šæ›´å¾Œå€¼,åŸå§‹å…¬å¼,è®Šæ›´å¾Œå…¬å¼,å…¬å¼å·®ç•°æ¯”è¼ƒ\\r\\n".length;')
        html.append('      console.log("CSVå…§å®¹é•·åº¦: " + csvContent.length + ", æ¨™é¡Œé•·åº¦: " + headerLength);')
        html.append('      if (csvContent.length <= headerLength) {')
        html.append('        alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºã€‚è«‹ç¢ºä¿æœ‰è³‡æ–™é¡¯ç¤ºåœ¨é é¢ä¸Šã€‚");')
        html.append('        return;')
        html.append('      }')
        html.append('      ')
        html.append('      // å‰µå»ºä¸‹è¼‰é€£çµ')
        html.append('      const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);')
        html.append('      const link = document.createElement("a");')
        html.append('      link.setAttribute("href", encodedUri);')
        html.append('      link.setAttribute("download", "excel_timeline_export_" + new Date().toISOString().replace(/[:.]/g, "-") + ".csv");')
        html.append('      document.body.appendChild(link);')
        html.append('      link.click();')
        html.append('      document.body.removeChild(link);')
        html.append('    } catch (e) {')
        html.append('      console.error("åŒ¯å‡ºCSVæ™‚å‡ºéŒ¯:", e);')
        html.append('      alert("åŒ¯å‡ºCSVæ™‚å‡ºéŒ¯: " + e.message);')
        html.append('    }')
        html.append('  }')
        html.append('  // åˆå§‹åŒ–è¦–åœ–')
        html.append('  updateSummary();')
        html.append('  updateFilters();')
        html.append('  viewByTime();')
        html.append('  // ç¶å®šæ¬„å¯¬æ§åˆ¶')
        html.append('  const apply = document.getElementById("applyWidths");')
        html.append('  const reset = document.getElementById("resetWidths");')
        html.append('  const valInput = document.getElementById("valWidth");')
        html.append('  const formInput = document.getElementById("formWidth");')
        html.append('  const VAL_KEY = "timeline_valWidth";')
        html.append('  const FORM_KEY = "timeline_formWidth";')
        html.append('  function setUserWidthsCSS(v, f, t, a, w, addr){')
        html.append('    let css = "";')
        html.append('    if (!Number.isNaN(v)) {')
        html.append('      css += ".diff-table .col-oldvalue, .diff-table .col-newvalue, .diff-table .col-valuediff{width:"+v+"px !important;min-width:"+v+"px !important;max-width:"+v+"px !important;}";')
        html.append('    }')
        html.append('    if (!Number.isNaN(f)) {')
        html.append('      css += ".diff-table .col-oldformula, .diff-table .col-newformula, .diff-table .col-formuladiff{width:"+f+"px !important;min-width:"+f+"px !important;max-width:"+f+"px !important;}";')
        html.append('    }')
        html.append('    if (!Number.isNaN(t)) { css += ".diff-table .col-time{width:"+t+"px !important;min-width:"+t+"px !important;max-width:"+t+"px !important;}"; }')
        html.append('    if (!Number.isNaN(a)) { css += ".diff-table .col-author{width:"+a+"px !important;min-width:"+a+"px !important;max-width:"+a+"px !important;}"; }')
        html.append('    if (!Number.isNaN(w)) { css += ".diff-table .col-worksheet{width:"+w+"px !important;min-width:"+w+"px !important;max-width:"+w+"px !important;}"; }')
        html.append('    if (!Number.isNaN(addr)) { css += ".diff-table .col-address{width:"+addr+"px !important;min-width:"+addr+"px !important;max-width:"+addr+"px !important;}"; }')
        html.append('    const ov = document.getElementById("user-widths"); if (ov) ov.remove();')
        html.append('    if (css){ const s=document.createElement("style"); s.id="user-widths"; s.textContent=css; document.head.appendChild(s);}')
        html.append('  }')
        html.append('  // åˆå§‹åŒ–ï¼šè®€å– localStorage ä¸¦å¥—ç”¨')
        html.append('  try {')
        html.append('    const sv = parseInt(localStorage.getItem(VAL_KEY)||""), sf = parseInt(localStorage.getItem(FORM_KEY)||"");')
        html.append('    const st = parseInt(localStorage.getItem("timeline_timeWidth")||""), sa = parseInt(localStorage.getItem("timeline_authorWidth")||""), sw = parseInt(localStorage.getItem("timeline_wsWidth")||""), sadd = parseInt(localStorage.getItem("timeline_addrWidth")||"");')
        html.append('    if (!Number.isNaN(st)) { const el=document.getElementById("timeWidth"); if (el) el.value = st; }')
        html.append('    if (!Number.isNaN(sa)) { const el=document.getElementById("authorWidth"); if (el) el.value = sa; }')
        html.append('    if (!Number.isNaN(sw)) { const el=document.getElementById("wsWidth"); if (el) el.value = sw; }')
        html.append('    if (!Number.isNaN(sadd)) { const el=document.getElementById("addrWidth"); if (el) el.value = sadd; }')
        html.append('    if (!Number.isNaN(st) || !Number.isNaN(sa) || !Number.isNaN(sw) || !Number.isNaN(sadd)) setUserWidthsCSS(sv, sf, st, sa, sw, sadd);')
        html.append('    if (!Number.isNaN(sv) && valInput) valInput.value = sv;')
        html.append('    if (!Number.isNaN(sf) && formInput) formInput.value = sf;')
        html.append('    if (!Number.isNaN(sv) || !Number.isNaN(sf)) setUserWidthsCSS(sv, sf);')
        html.append('  } catch(e) { console.warn("[index3] localStorage init warn", e); }')
        html.append('  // åˆå§‹åŒ– decimals æ§åˆ¶èˆ‡äº‹ä»¶ç›£è½')
        html.append('  const decInput = document.getElementById("decimals");')
        html.append('  if (decInput) {')
        html.append('    // è¼‰å…¥æ™‚å¾ localStorage æ¢å¾©è¨­å®š')
        html.append('    try { const savedDec = parseInt(localStorage.getItem(DEC_KEY)||""); if(!Number.isNaN(savedDec)) decInput.value = String(savedDec); } catch(e) {}')
        html.append('    // ç›£è½è®Šæ›´äº‹ä»¶')
        html.append('    // ç›£è½ change å’Œ keydown äº‹ä»¶')
        html.append('    function handleDecimalsChange() {')
        html.append('      const v = parseInt(decInput.value);')
        html.append('      if (!Number.isNaN(v)) { try { localStorage.setItem(DEC_KEY, String(Math.min(Math.max(v,0),10))); } catch(e){} }')
        html.append('      // é‡æ–°æ¸²æŸ“ç•¶å‰æª”æ¡ˆè¦–åœ–')
        html.append('      try { const currentFile = document.querySelector("#file-view")?.getAttribute("data-current-file"); if(currentFile) renderFileView(currentFile); } catch(e){}')
        html.append('    }')
        html.append('    ')
        html.append('    decInput.addEventListener("change", handleDecimalsChange);')
        html.append('    decInput.addEventListener("keydown", (e)=>{')
        html.append('      if (e.key === "Enter") {')
        html.append('        e.preventDefault();')
        html.append('        handleDecimalsChange();')
        html.append('      }')
        html.append('    });')
        html.append('  }')
        html.append('  ')
        html.append('  // ç‚ºæ‰€æœ‰å¯¬åº¦è¼¸å…¥æ¡†æ·»åŠ  Enter éµæ”¯æ´')
        html.append('  function applyWidthSettings() {')
        html.append('    const v = parseInt(valInput?.value);')
        html.append('    const f = parseInt(formInput?.value);')
        html.append('    const t = parseInt(document.getElementById("timeWidth")?.value);')
        html.append('    const a = parseInt(document.getElementById("authorWidth")?.value);')
        html.append('    const w = parseInt(document.getElementById("wsWidth")?.value);')
        html.append('    const addr = parseInt(document.getElementById("addrWidth")?.value);')
        html.append('    setUserWidthsCSS(v, f, t, a, w, addr);')
        html.append('    try { if (!Number.isNaN(v)) localStorage.setItem(VAL_KEY, String(v)); } catch(e){}')
        html.append('    try { if (!Number.isNaN(f)) localStorage.setItem(FORM_KEY, String(f)); } catch(e){}')
        html.append('    try { if (!Number.isNaN(t)) localStorage.setItem("timeline_timeWidth", String(t)); } catch(e){}')
        html.append('    try { if (!Number.isNaN(a)) localStorage.setItem("timeline_authorWidth", String(a)); } catch(e){}')
        html.append('    try { if (!Number.isNaN(w)) localStorage.setItem("timeline_wsWidth", String(w)); } catch(e){}')
        html.append('    try { if (!Number.isNaN(addr)) localStorage.setItem("timeline_addrWidth", String(addr)); } catch(e){}')
        html.append('  }')
        html.append('  ')
        html.append('  // ç‚ºæ‰€æœ‰å¯¬åº¦è¼¸å…¥æ¡†æ·»åŠ  Enter éµç›£è½å™¨')
        html.append('  const widthInputs = ["valWidth", "formWidth", "timeWidth", "authorWidth", "wsWidth", "addrWidth"];')
        html.append('  widthInputs.forEach(inputId => {')
        html.append('    const input = document.getElementById(inputId);')
        html.append('    if (input) {')
        html.append('      input.addEventListener("keydown", (e) => {')
        html.append('        if (e.key === "Enter") {')
        html.append('          e.preventDefault();')
        html.append('          applyWidthSettings();')
        html.append('        }')
        html.append('      });')
        html.append('    }')
        html.append('  });')
        html.append('  ')
        html.append('  if (apply) {')
        html.append('    apply.addEventListener("click", applyWidthSettings);')
        html.append('  }')
        html.append('  if (reset) {')
        html.append('    reset.addEventListener("click", ()=>{')
        html.append('      const ov = document.getElementById("user-widths"); if (ov) ov.remove();')
        html.append('      try { localStorage.removeItem(VAL_KEY); localStorage.removeItem(FORM_KEY); } catch(e){}')
        html.append('    });')
        html.append('  }')
        html.append('  } catch (e) {')
        html.append('    console.error("æ¸²æŸ“æª”æ¡ˆè¦–åœ–æ™‚å‡ºéŒ¯:", e);')
        html.append('  }')
        html.append('}')
        html.append("// åˆå§‹åŒ–é é¢")
        html.append("function initializePage() {")
        html.append("  document.querySelectorAll('a.file-link').forEach(a=>{ ")
        html.append("    a.addEventListener('click', function(ev) {")
        html.append("      ev.preventDefault();") 
        html.append("      renderFileView(this.getAttribute('data-file'));")
        html.append("    });")
        html.append("  });")
        html.append("}")
        html.append("")
        html.append("// ç¢ºä¿DOMå®Œå…¨è¼‰å…¥")
        html.append("if (document.readyState === 'loading') {")
        html.append("  document.addEventListener('DOMContentLoaded', initializePage);")
        html.append("} else {")
        html.append("  initializePage();")
        html.append("}")
        html.append("document.addEventListener('click', function(ev){")
        html.append("  const a = ev.target.closest('a.file-link');")
        html.append("  if (!a) return;")
        html.append("  ev.preventDefault();")
        html.append("  const f = a.getAttribute('data-file');")
        html.append("  console.debug('[index3] file-link click:', f);")
        html.append("  try { renderFileView(f); } catch (e) { console.error('[index3] renderFileView error:', e); }")
        html.append("});")
        html.append("console.info('[index3] ready. file-link count=', document.querySelectorAll('a.file-link').length);")
        html.append('</script>')
        html.append('</body></html>')
        try:
            # æ±ºå®šè¼¸å‡ºæª”æ¡ˆè·¯å¾‘
            final_output_path = output_path or TIMELINE_HTML_MATRIX_CLEAN
            # ç¢ºä¿ç›®éŒ„å­˜åœ¨
            os.makedirs(os.path.dirname(final_output_path), exist_ok=True)
            # å¯«å…¥æª”æ¡ˆ
            with open(final_output_path, 'w', encoding='utf-8') as f:
                f.write('\n'.join(html))
            # Debug copy into workspace for analysis
            try:
                with open('tmp_rovodev_index2_debug.html', 'w', encoding='utf-8') as fdbg:
                    fdbg.write('\n'.join(html))
            except Exception:
                pass
            # è¼¸å‡ºæˆåŠŸè¨Šæ¯
            # ç¸½æ˜¯é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            print(f"[timeline-matrix-clean] HTML æˆåŠŸå¯«å…¥: {final_output_path}")
            if getattr(settings, 'SHOW_DEBUG_MESSAGES', False):
                print(f"[timeline-matrix-clean] HTML è©³ç´°ä¿¡æ¯å·²å¯«å…¥ {final_output_path}")
        except Exception as e:
            if getattr(settings, 'SHOW_DEBUG_MESSAGES', False):
                print(f"[timeline-matrix-clean] å¯«å…¥ HTML å¤±æ•—: {e}")
    except Exception:
        pass
